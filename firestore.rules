/**
 * @description This ruleset enforces a role-based access control model, with special considerations for employee data and related subcollections.
 * Nesta versão, as subcoleções de employees foram deixadas permissivas para qualquer usuário autenticado,
 * para facilitar testes de UI (selecionar usuário e registrar interação).
 * 
 * Qualquer usuário autenticado pode criar interações.
 * Validações de permissão (isDirector, isAdmin) são feitas no frontend.
 */

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    /**
     * /employees - Coleção de employees
     * - Permite queries (list) na coleção para qualquer usuário autenticado
     */
    match /employees {
      // Permitir listar a coleção employees (queries)
      allow list: if isSignedIn();
    }

    /**
     * /employees/{employeeId}
     * - leitura pública
     * - criação/edição: qualquer logado
     * - exclusão: apenas admin
     */
    match /employees/{employeeId} {
      // qualquer um pode listar/ver employees
      allow read: if true;
      // criar e atualizar: qualquer usuário autenticado
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      // apagar: só admin
      allow delete: if isAdmin();

      // ============================
      // SUBCOLEÇÕES PERMISSIVAS
      // ============================
      match /interactions/{interactionId} {
        // Qualquer usuário autenticado pode ler e escrever interações
        allow read, write: if isSignedIn();
      }

      match /pdiActions/{pdiActionId} {
        allow read, write: if isSignedIn();
      }

      match /meetings/{meetingId} {
        allow read, write: if isSignedIn();
      }
    }

    /**
     * /roles e /teams continuam públicos
     */
    match /roles/{roleId} {
      allow read: if true;
    }

    match /teams/{teamId} {
      allow read: if true;
    }

    /**
     * /leaderRankings - apenas leitura pública, escrita por Cloud Functions
     */
    match /leaderRankings/{leaderId} {
      allow read: if true;
      allow write: if false; // Protege contra escrita client-side
    }

    /**
     * /projects - Projetos Independentes
     * - Permissivo para usuários autenticados
     * - Validações de permissão acontecem no frontend
     * - Criador automaticamente se torna líder do projeto
     */
    match /projects/{projectId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
      
      // Subcoleção de interações do projeto
      match /interactions/{interactionId} {
        allow read, write: if isSignedIn();
      }
    }

    /**
     * /configs - Configurações Gerais do Sistema
     * - Leitura: qualquer usuário autenticado
     * - Escrita: qualquer usuário autenticado (controle de acesso via frontend)
     */
    match /configs/{configId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }
  }

  // ============================
  // Helper functions
  // ============================
  function isSignedIn() {
    return request.auth != null;
  }

  function isAdmin() {
    return isSignedIn() && request.auth.token.isAdmin == true;
  }

}
